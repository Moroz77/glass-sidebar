<!-- Tilda embed: use internal FAB (mini iframe) + fullscreen overlay via postMessage -->
<style>
  :root{ --kb-sidebar-width: 260px; }

  /* Мини‑виджет: внутренняя FAB из booking/ */
  #kb-mini-frame{
    position: fixed;
    right: 18px;
    bottom: 18px;
    width: 120px;
    height: 120px;
    border: 0;
    background: transparent;
    z-index: 2147483500; /* выше сайдбара, ниже фулскрина */
  }
  @media (max-width:600px){ #kb-mini-frame{ width:100px; height:100px; } }

  /* Полноэкранный оверлей + iframe */
  #kb-full-overlay{
    position: fixed; inset: 0;
    display: none; align-items: stretch;
    background: transparent; z-index: 2147483600;
  }
  #kb-full-overlay.is-open{ display: flex; }
  /* На десктопе не закрываем левый сайдбар */
  @media (min-width:1025px){ #kb-full-overlay{ left: var(--kb-sidebar-width); } }
  /* На мобильных прячем мини‑кнопку, когда открыт оверлей */
  @media (hover:none), (pointer:coarse){ .kb-overlay-open #kb-mini-frame{ display:none !important; } }
  /* На десктопе во время оверлея отключаем клики по мини‑кнопке и поднимаем z-index */
  .kb-overlay-open #kb-mini-frame{ pointer-events:none; z-index:2147483602; }

  #kb-full-frame{ flex:1; border:0; background:transparent; width:100%; height:100%; }
  .kb-overlay-close{
    position: fixed; top: 12px; right: 12px; z-index: 2147483601;
    width: 44px; height: 44px; border: 0; border-radius: 50%;
    background: rgba(0,0,0,.6); color: #fff; font-size: 28px; line-height: 44px; cursor: pointer;
  }
  html.kb-noscroll, body.kb-noscroll{ overflow: hidden !important; }
</style>

<!-- Мини‑фрейм с внутренней FAB -->
<iframe
  id="kb-mini-frame"
  title="Калиновая баня — кнопка бронирования"
  src="https://moroz77.github.io/glass-sidebar/booking/?mini=1&staticfab=1"
  style="display:block"
  referrerpolicy="no-referrer">
</iframe>

<!-- Фулскрин с открытой карточкой -->
<div id="kb-full-overlay" aria-hidden="true">
  <iframe
    id="kb-full-frame"
    title="Калиновая баня — бронирование"
    src="about:blank"
    referrerpolicy="no-referrer">
  </iframe>
  <button class="kb-overlay-close" aria-label="Закрыть">×</button>
</div>

<script>
  (function(){
    var MINI_SRC = 'https://moroz77.github.io/glass-sidebar/booking/';
    var FULL_SRC = 'https://moroz77.github.io/glass-sidebar/booking/#kb-booking';
    var mini = document.getElementById('kb-mini-frame');
    var overlay = document.getElementById('kb-full-overlay');
    var full = document.getElementById('kb-full-frame');
    var closeBtn = overlay.querySelector('.kb-overlay-close');
    function isMobile(){
      try { return window.matchMedia('(hover: none), (pointer: coarse)').matches; }
      catch(_) { return window.innerWidth <= 1024; }
    }
    function lockScroll(on){ if (isMobile()) { document.documentElement.classList.toggle('kb-noscroll', on); document.body.classList.toggle('kb-noscroll', on); } }
    function ensureMiniVisible(){
      try{
        if (!mini) return;
        mini.removeAttribute('hidden');
        mini.style.display = 'block';
        mini.style.opacity = '1';
        mini.style.visibility = 'visible';
        mini.style.zIndex = mini.style.zIndex || '2147483500';
        mini.style.pointerEvents = mini.style.pointerEvents || 'auto';
      }catch(_){}
    }
    function openOverlay(){
      if (full.src !== FULL_SRC) full.src = FULL_SRC;
      overlay.classList.add('is-open');
      document.documentElement.classList.add('kb-overlay-open');
      lockScroll(true);
    }
    function closeOverlay(){
      overlay.classList.remove('is-open');
      document.documentElement.classList.remove('kb-overlay-open');
      lockScroll(false);
      // Дважды подтверждаем видимость FAB на случай внешних стилей
      ensureMiniVisible();
      setTimeout(ensureMiniVisible, 50);
      setTimeout(ensureMiniVisible, 300);
    }

    // Слушаем события из booking/ (postMessage)
    window.addEventListener('message', function(e){
      if (!/^https:\/\/moroz77\.github\.io$/.test(e.origin)) return;
      var d = e.data || {};
      if (d.source === 'kb') {
        if (d.type === 'kb-open') openOverlay();
        else if (d.type === 'kb-close') closeOverlay();
      }
    });

    closeBtn.addEventListener('click', function(e){ e.preventDefault(); closeOverlay(); });
    overlay.addEventListener('click', function(e){ if (e.target === overlay) closeOverlay(); });
    window.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeOverlay(); });
    window.addEventListener('resize', function(){ if (!overlay.classList.contains('is-open')) return; if (isMobile()) lockScroll(true); else lockScroll(false); });
    // Сброс класса на старте и гарантированная видимость FAB
    document.documentElement.classList.remove('kb-overlay-open');
    ensureMiniVisible();
  })();
</script>
